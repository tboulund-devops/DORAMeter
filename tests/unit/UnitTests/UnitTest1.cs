using BLL.GitHubPayloadStrategies;
using Dapper;
using DefaultNamespace;
using MySql.Data.MySqlClient;
using Newtonsoft.Json.Linq;

namespace UnitTests;

public class GitHubPayloadTests
{
    [SetUp]
    public void Setup()
    {
        using var connection = new MySqlConnection("Server=localhost;Database=dora_meter;User=dbadmin;Password=TogetherCenterExceptThusFew");
        connection.Open();
        
        using var transaction = connection.BeginTransaction();

        connection.Execute("SET FOREIGN_KEY_CHECKS = 0;");
        connection.Execute("TRUNCATE TABLE branches");
        connection.Execute("TRUNCATE TABLE deployments");
        connection.Execute("TRUNCATE TABLE repositories");
        connection.Execute("SET FOREIGN_KEY_CHECKS = 1;");
        
        transaction.Commit();
    }

    [Test]
    public void Test1()
    {
        // Arrange
        var connection = new MySqlConnection("Server=localhost;Database=dora_meter;User=dbadmin;Password=TogetherCenterExceptThusFew");
        var router = GitHubPayloadRouter.Instance;
        dynamic payload = JObject.Parse("{      \"ref\": \"refs/heads/feature/DatabaseMigrations\",      \"before\": \"0000000000000000000000000000000000000000\",      \"after\": \"c52352841ee3680e302b3f4aa8995156a1b03be0\",      \"repository\": {          \"id\": 884841042,          \"node_id\": \"R_kgDONL2aUg\",          \"name\": \"DORAMeter\",          \"full_name\": \"tboulund-devops/DORAMeter\",          \"private\": true,          \"owner\": {              \"name\": \"tboulund-devops\",              \"email\": null,              \"login\": \"tboulund-devops\",              \"id\": 76437150,              \"node_id\": \"MDEyOk9yZ2FuaXphdGlvbjc2NDM3MTUw\",              \"avatar_url\": \"https://avatars.githubusercontent.com/u/76437150?v=4\",              \"gravatar_id\": \"\",              \"url\": \"https://api.github.com/users/tboulund-devops\",              \"html_url\": \"https://github.com/tboulund-devops\",              \"followers_url\": \"https://api.github.com/users/tboulund-devops/followers\",              \"following_url\": \"https://api.github.com/users/tboulund-devops/following{/other_user}\",              \"gists_url\": \"https://api.github.com/users/tboulund-devops/gists{/gist_id}\",              \"starred_url\": \"https://api.github.com/users/tboulund-devops/starred{/owner}{/repo}\",              \"subscriptions_url\": \"https://api.github.com/users/tboulund-devops/subscriptions\",              \"organizations_url\": \"https://api.github.com/users/tboulund-devops/orgs\",              \"repos_url\": \"https://api.github.com/users/tboulund-devops/repos\",              \"events_url\": \"https://api.github.com/users/tboulund-devops/events{/privacy}\",              \"received_events_url\": \"https://api.github.com/users/tboulund-devops/received_events\",              \"type\": \"Organization\",              \"user_view_type\": \"public\",              \"site_admin\": false          },          \"html_url\": \"https://github.com/tboulund-devops/DORAMeter\",          \"description\": null,          \"fork\": false,          \"url\": \"https://github.com/tboulund-devops/DORAMeter\",          \"forks_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/forks\",          \"keys_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/keys{/key_id}\",          \"collaborators_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/collaborators{/collaborator}\",          \"teams_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/teams\",          \"hooks_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/hooks\",          \"issue_events_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/issues/events{/number}\",          \"events_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/events\",          \"assignees_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/assignees{/user}\",          \"branches_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/branches{/branch}\",          \"tags_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/tags\",          \"blobs_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/git/blobs{/sha}\",          \"git_tags_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/git/tags{/sha}\",          \"git_refs_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/git/refs{/sha}\",          \"trees_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/git/trees{/sha}\",          \"statuses_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/statuses/{sha}\",          \"languages_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/languages\",          \"stargazers_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/stargazers\",          \"contributors_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/contributors\",          \"subscribers_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/subscribers\",          \"subscription_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/subscription\",          \"commits_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/commits{/sha}\",          \"git_commits_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/git/commits{/sha}\",          \"comments_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/comments{/number}\",          \"issue_comment_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/issues/comments{/number}\",          \"contents_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/contents/{\\u002Bpath}\",          \"compare_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/compare/{base}...{head}\",          \"merges_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/merges\",          \"archive_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/{archive_format}{/ref}\",          \"downloads_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/downloads\",          \"issues_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/issues{/number}\",          \"pulls_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/pulls{/number}\",          \"milestones_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/milestones{/number}\",          \"notifications_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/notifications{?since,all,participating}\",          \"labels_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/labels{/name}\",          \"releases_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/releases{/id}\",          \"deployments_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/deployments\",          \"created_at\": 1730986818,          \"updated_at\": \"2024-11-11T07:54:37Z\",          \"pushed_at\": 1731314993,          \"git_url\": \"git://github.com/tboulund-devops/DORAMeter.git\",          \"ssh_url\": \"git@github.com:tboulund-devops/DORAMeter.git\",          \"clone_url\": \"https://github.com/tboulund-devops/DORAMeter.git\",          \"svn_url\": \"https://github.com/tboulund-devops/DORAMeter\",          \"homepage\": null,          \"size\": 902,          \"stargazers_count\": 0,          \"watchers_count\": 0,          \"language\": \"C#\",          \"has_issues\": true,          \"has_projects\": true,          \"has_downloads\": true,          \"has_wiki\": false,          \"has_pages\": false,          \"has_discussions\": false,          \"forks_count\": 0,          \"mirror_url\": null,          \"archived\": false,          \"disabled\": false,          \"open_issues_count\": 2,          \"license\": null,          \"allow_forking\": false,          \"is_template\": false,          \"web_commit_signoff_required\": false,          \"topics\": [],          \"visibility\": \"private\",          \"forks\": 0,          \"open_issues\": 2,          \"watchers\": 0,          \"default_branch\": \"main\",          \"stargazers\": 0,          \"master_branch\": \"main\",          \"organization\": \"tboulund-devops\",          \"custom_properties\": {}      },      \"pusher\": {          \"name\": \"tboulund\",          \"email\": \"69308037\\u002Btboulund@users.noreply.github.com\"      },      \"organization\": {          \"login\": \"tboulund-devops\",          \"id\": 76437150,          \"node_id\": \"MDEyOk9yZ2FuaXphdGlvbjc2NDM3MTUw\",          \"url\": \"https://api.github.com/orgs/tboulund-devops\",          \"repos_url\": \"https://api.github.com/orgs/tboulund-devops/repos\",          \"events_url\": \"https://api.github.com/orgs/tboulund-devops/events\",          \"hooks_url\": \"https://api.github.com/orgs/tboulund-devops/hooks\",          \"issues_url\": \"https://api.github.com/orgs/tboulund-devops/issues\",          \"members_url\": \"https://api.github.com/orgs/tboulund-devops/members{/member}\",          \"public_members_url\": \"https://api.github.com/orgs/tboulund-devops/public_members{/member}\",          \"avatar_url\": \"https://avatars.githubusercontent.com/u/76437150?v=4\",          \"description\": null      },      \"sender\": {          \"login\": \"tboulund\",          \"id\": 69308037,          \"node_id\": \"MDQ6VXNlcjY5MzA4MDM3\",          \"avatar_url\": \"https://avatars.githubusercontent.com/u/69308037?v=4\",          \"gravatar_id\": \"\",          \"url\": \"https://api.github.com/users/tboulund\",          \"html_url\": \"https://github.com/tboulund\",          \"followers_url\": \"https://api.github.com/users/tboulund/followers\",          \"following_url\": \"https://api.github.com/users/tboulund/following{/other_user}\",          \"gists_url\": \"https://api.github.com/users/tboulund/gists{/gist_id}\",          \"starred_url\": \"https://api.github.com/users/tboulund/starred{/owner}{/repo}\",          \"subscriptions_url\": \"https://api.github.com/users/tboulund/subscriptions\",          \"organizations_url\": \"https://api.github.com/users/tboulund/orgs\",          \"repos_url\": \"https://api.github.com/users/tboulund/repos\",          \"events_url\": \"https://api.github.com/users/tboulund/events{/privacy}\",          \"received_events_url\": \"https://api.github.com/users/tboulund/received_events\",          \"type\": \"User\",          \"user_view_type\": \"public\",          \"site_admin\": false      },      \"created\": true,      \"deleted\": false,      \"forced\": false,      \"base_ref\": null,      \"compare\": \"https://github.com/tboulund-devops/DORAMeter/compare/3a1991b51406^...c52352841ee3\",      \"commits\": [          {              \"id\": \"3a1991b514060c2d537624eafbf985077870fc8f\",              \"tree_id\": \"55139603a88b7309f06211821716279f6c51bf8a\",              \"distinct\": true,              \"message\": \"Wrote migrations and repeatable data configuration for Flyway\",              \"timestamp\": \"2024-11-11T09:19:33\\u002B01:00\",              \"url\": \"https://github.com/tboulund-devops/DORAMeter/commit/3a1991b514060c2d537624eafbf985077870fc8f\",              \"author\": {                  \"name\": \"tboulund\",                  \"email\": \"tbmh@easv.dk\",                  \"username\": \"tboulund\"              },              \"committer\": {                  \"name\": \"tboulund\",                  \"email\": \"tbmh@easv.dk\",                  \"username\": \"tboulund\"              },              \"added\": [                  \"db/R__Populate_branch_types_table.sql\",                  \"db/V1__Create_repository_table.sql\",                  \"db/V2__Create_branch_type_table.sql\",                  \"db/V3__Create_branch_table.sql\"              ],              \"removed\": [],              \"modified\": []          },          {              \"id\": \"c52352841ee3680e302b3f4aa8995156a1b03be0\",              \"tree_id\": \"ae6efaedbcfb9b39a52da3bdb2f8c21eb1cdfe5b\",              \"distinct\": true,              \"message\": \"Removed sample\\ngit push\\n:\",              \"timestamp\": \"2024-11-11T09:49:29\\u002B01:00\",              \"url\": \"https://github.com/tboulund-devops/DORAMeter/commit/c52352841ee3680e302b3f4aa8995156a1b03be0\",              \"author\": {                  \"name\": \"tboulund\",                  \"email\": \"tbmh@easv.dk\",                  \"username\": \"tboulund\"              },              \"committer\": {                  \"name\": \"tboulund\",                  \"email\": \"tbmh@easv.dk\",                  \"username\": \"tboulund\"              },              \"added\": [],              \"removed\": [                  \"docs/samples/release-ok-created.json\"              ],              \"modified\": []          }      ],      \"head_commit\": {          \"id\": \"c52352841ee3680e302b3f4aa8995156a1b03be0\",          \"tree_id\": \"ae6efaedbcfb9b39a52da3bdb2f8c21eb1cdfe5b\",          \"distinct\": true,          \"message\": \"Removed sample\\ngit push\\n:\",          \"timestamp\": \"2024-11-11T09:49:29\\u002B01:00\",          \"url\": \"https://github.com/tboulund-devops/DORAMeter/commit/c52352841ee3680e302b3f4aa8995156a1b03be0\",          \"author\": {              \"name\": \"tboulund\",              \"email\": \"tbmh@easv.dk\",              \"username\": \"tboulund\"          },          \"committer\": {              \"name\": \"tboulund\",              \"email\": \"tbmh@easv.dk\",              \"username\": \"tboulund\"          },          \"added\": [],          \"removed\": [              \"docs/samples/release-ok-created.json\"          ],          \"modified\": []      }  }");
        
        // Act
        router.Process(payload);
        
        // Assert
        Assert.AreEqual(1, connection.ExecuteScalar<int>("SELECT COUNT(*) FROM repositories WHERE name = @RepositoryName", new { RepositoryName = "tboulund-devops/DORAMeter" }));
        Assert.AreEqual(1, connection.ExecuteScalar<int>("SELECT COUNT(*) FROM branches WHERE name = @BranchName AND branch_type_id = @BranchType", new { BranchName = "feature/DatabaseMigrations", BranchType = RegisterBranchHandler.BranchTypes.Feature }));
    }
}