using BLL.GitHubPayloadStrategies;
using Dapper;
using DefaultNamespace;
using MySql.Data.MySqlClient;
using Newtonsoft.Json.Linq;

namespace UnitTests;

public class GitHubPayloadTests
{
    [SetUp]
    public void Setup()
    {
        using var connection = new MySqlConnection("Server=localhost;Database=dora_meter;User=dbadmin;Password=TogetherCenterExceptThusFew");
        connection.Open();
        
        using var transaction = connection.BeginTransaction();

        connection.Execute("SET FOREIGN_KEY_CHECKS = 0;");
        connection.Execute("TRUNCATE TABLE branches");
        connection.Execute("TRUNCATE TABLE deployments");
        connection.Execute("TRUNCATE TABLE repositories");
        connection.Execute("SET FOREIGN_KEY_CHECKS = 1;");
        
        transaction.Commit();
    }

    [Test]
    public void SinglePushReceived()
    {
        // Arrange
        var connection = new MySqlConnection("Server=localhost;Database=dora_meter;User=dbadmin;Password=TogetherCenterExceptThusFew");
        var router = GitHubPayloadRouter.Instance;
        dynamic payload = GetPushPayload("feature/DatabaseMigrations", "tboulund-devops/DORAMeter");
        
        // Act
        router.Process(payload);
        
        // Assert
        Assert.AreEqual(1, connection.ExecuteScalar<int>("SELECT COUNT(*) FROM repositories WHERE name = @RepositoryName", new { RepositoryName = "tboulund-devops/DORAMeter" }));
        Assert.AreEqual(1, connection.ExecuteScalar<int>("SELECT COUNT(*) FROM branches WHERE name = @BranchName AND branch_type_id = @BranchType", new { BranchName = "feature/DatabaseMigrations", BranchType = RegisterBranchHandler.BranchTypes.Feature }));
    }

    [Test]
    public void DoublePushReceivedSameRepository()
    {
        // Arrange
        var connection = new MySqlConnection("Server=localhost;Database=dora_meter;User=dbadmin;Password=TogetherCenterExceptThusFew");
        var router = GitHubPayloadRouter.Instance;
        dynamic payload1 = GetPushPayload("feature/DatabaseMigrations", "tboulund-devops/DORAMeter");
        dynamic payload2 = GetPushPayload("feature/Dashboard", "tboulund-devops/DORAMeter");
        
        // Act
        router.Process(payload1);
        router.Process(payload2);
        
        // Assert
        Assert.That(connection.ExecuteScalar<int>("SELECT COUNT(*) FROM repositories"), Is.EqualTo(1));
        Assert.That(connection.ExecuteScalar<int>("SELECT COUNT(*) FROM branches"), Is.EqualTo(2));
    }

    private dynamic GetPushPayload(string branchName, string repositoryName)
    {
        var branchId = branchName.GetHashCode();
        var repositoryId = repositoryName.GetHashCode();
        return JObject.Parse("{\n    \"ref\": \"refs/heads/" + branchName + "\",\n    \"before\": \"0000000000000000000000000000000000000000\",\n    \"after\": \"c52352841ee3680e302b3f4aa8995156a1b03be0\",\n    \"repository\": {\n        \"id\": " + repositoryId + ",\n        \"node_id\": \"R_kgDONL2aUg\",\n        \"name\": \"DORAMeter\",\n        \"full_name\": \"" + repositoryName + "\",\n        \"private\": true,\n        \"owner\": {\n            \"name\": \"tboulund-devops\",\n            \"email\": null,\n            \"login\": \"tboulund-devops\",\n            \"id\": 76437150,\n            \"node_id\": \"MDEyOk9yZ2FuaXphdGlvbjc2NDM3MTUw\",\n            \"avatar_url\": \"https://avatars.githubusercontent.com/u/76437150?v=4\",\n            \"gravatar_id\": \"\",\n            \"url\": \"https://api.github.com/users/tboulund-devops\",\n            \"html_url\": \"https://github.com/tboulund-devops\",\n            \"followers_url\": \"https://api.github.com/users/tboulund-devops/followers\",\n            \"following_url\": \"https://api.github.com/users/tboulund-devops/following{/other_user}\",\n            \"gists_url\": \"https://api.github.com/users/tboulund-devops/gists{/gist_id}\",\n            \"starred_url\": \"https://api.github.com/users/tboulund-devops/starred{/owner}{/repo}\",\n            \"subscriptions_url\": \"https://api.github.com/users/tboulund-devops/subscriptions\",\n            \"organizations_url\": \"https://api.github.com/users/tboulund-devops/orgs\",\n            \"repos_url\": \"https://api.github.com/users/tboulund-devops/repos\",\n            \"events_url\": \"https://api.github.com/users/tboulund-devops/events{/privacy}\",\n            \"received_events_url\": \"https://api.github.com/users/tboulund-devops/received_events\",\n            \"type\": \"Organization\",\n            \"user_view_type\": \"public\",\n            \"site_admin\": false\n        },\n        \"html_url\": \"https://github.com/tboulund-devops/DORAMeter\",\n        \"description\": null,\n        \"fork\": false,\n        \"url\": \"https://github.com/tboulund-devops/DORAMeter\",\n        \"forks_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/forks\",\n        \"keys_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/keys{/key_id}\",\n        \"collaborators_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/collaborators{/collaborator}\",\n        \"teams_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/teams\",\n        \"hooks_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/hooks\",\n        \"issue_events_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/issues/events{/number}\",\n        \"events_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/events\",\n        \"assignees_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/assignees{/user}\",\n        \"branches_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/branches{/branch}\",\n        \"tags_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/tags\",\n        \"blobs_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/git/blobs{/sha}\",\n        \"git_tags_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/git/tags{/sha}\",\n        \"git_refs_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/git/refs{/sha}\",\n        \"trees_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/git/trees{/sha}\",\n        \"statuses_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/statuses/{sha}\",\n        \"languages_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/languages\",\n        \"stargazers_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/stargazers\",\n        \"contributors_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/contributors\",\n        \"subscribers_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/subscribers\",\n        \"subscription_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/subscription\",\n        \"commits_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/commits{/sha}\",\n        \"git_commits_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/git/commits{/sha}\",\n        \"comments_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/comments{/number}\",\n        \"issue_comment_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/issues/comments{/number}\",\n        \"contents_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/contents/{\\u002Bpath}\",\n        \"compare_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/compare/{base}...{head}\",\n        \"merges_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/merges\",\n        \"archive_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/{archive_format}{/ref}\",\n        \"downloads_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/downloads\",\n        \"issues_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/issues{/number}\",\n        \"pulls_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/pulls{/number}\",\n        \"milestones_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/milestones{/number}\",\n        \"notifications_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/notifications{?since,all,participating}\",\n        \"labels_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/labels{/name}\",\n        \"releases_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/releases{/id}\",\n        \"deployments_url\": \"https://api.github.com/repos/tboulund-devops/DORAMeter/deployments\",\n        \"created_at\": 1730986818,\n        \"updated_at\": \"2024-11-11T07:54:37Z\",\n        \"pushed_at\": 1731314993,\n        \"git_url\": \"git://github.com/tboulund-devops/DORAMeter.git\",\n        \"ssh_url\": \"git@github.com:tboulund-devops/DORAMeter.git\",\n        \"clone_url\": \"https://github.com/tboulund-devops/DORAMeter.git\",\n        \"svn_url\": \"https://github.com/tboulund-devops/DORAMeter\",\n        \"homepage\": null,\n        \"size\": 902,\n        \"stargazers_count\": 0,\n        \"watchers_count\": 0,\n        \"language\": \"C#\",\n        \"has_issues\": true,\n        \"has_projects\": true,\n        \"has_downloads\": true,\n        \"has_wiki\": false,\n        \"has_pages\": false,\n        \"has_discussions\": false,\n        \"forks_count\": 0,\n        \"mirror_url\": null,\n        \"archived\": false,\n        \"disabled\": false,\n        \"open_issues_count\": 2,\n        \"license\": null,\n        \"allow_forking\": false,\n        \"is_template\": false,\n        \"web_commit_signoff_required\": false,\n        \"topics\": [],\n        \"visibility\": \"private\",\n        \"forks\": 0,\n        \"open_issues\": 2,\n        \"watchers\": 0,\n        \"default_branch\": \"main\",\n        \"stargazers\": 0,\n        \"master_branch\": \"main\",\n        \"organization\": \"tboulund-devops\",\n        \"custom_properties\": {}\n    },\n    \"pusher\": {\n        \"name\": \"tboulund\",\n        \"email\": \"69308037\\u002Btboulund@users.noreply.github.com\"\n    },\n    \"organization\": {\n        \"login\": \"tboulund-devops\",\n        \"id\": 76437150,\n        \"node_id\": \"MDEyOk9yZ2FuaXphdGlvbjc2NDM3MTUw\",\n        \"url\": \"https://api.github.com/orgs/tboulund-devops\",\n        \"repos_url\": \"https://api.github.com/orgs/tboulund-devops/repos\",\n        \"events_url\": \"https://api.github.com/orgs/tboulund-devops/events\",\n        \"hooks_url\": \"https://api.github.com/orgs/tboulund-devops/hooks\",\n        \"issues_url\": \"https://api.github.com/orgs/tboulund-devops/issues\",\n        \"members_url\": \"https://api.github.com/orgs/tboulund-devops/members{/member}\",\n        \"public_members_url\": \"https://api.github.com/orgs/tboulund-devops/public_members{/member}\",\n        \"avatar_url\": \"https://avatars.githubusercontent.com/u/76437150?v=4\",\n        \"description\": null\n    },\n    \"sender\": {\n        \"login\": \"tboulund\",\n        \"id\": 69308037,\n        \"node_id\": \"MDQ6VXNlcjY5MzA4MDM3\",\n        \"avatar_url\": \"https://avatars.githubusercontent.com/u/69308037?v=4\",\n        \"gravatar_id\": \"\",\n        \"url\": \"https://api.github.com/users/tboulund\",\n        \"html_url\": \"https://github.com/tboulund\",\n        \"followers_url\": \"https://api.github.com/users/tboulund/followers\",\n        \"following_url\": \"https://api.github.com/users/tboulund/following{/other_user}\",\n        \"gists_url\": \"https://api.github.com/users/tboulund/gists{/gist_id}\",\n        \"starred_url\": \"https://api.github.com/users/tboulund/starred{/owner}{/repo}\",\n        \"subscriptions_url\": \"https://api.github.com/users/tboulund/subscriptions\",\n        \"organizations_url\": \"https://api.github.com/users/tboulund/orgs\",\n        \"repos_url\": \"https://api.github.com/users/tboulund/repos\",\n        \"events_url\": \"https://api.github.com/users/tboulund/events{/privacy}\",\n        \"received_events_url\": \"https://api.github.com/users/tboulund/received_events\",\n        \"type\": \"User\",\n        \"user_view_type\": \"public\",\n        \"site_admin\": false\n    },\n    \"created\": true,\n    \"deleted\": false,\n    \"forced\": false,\n    \"base_ref\": null,\n    \"compare\": \"https://github.com/tboulund-devops/DORAMeter/compare/3a1991b51406^...c52352841ee3\",\n    \"commits\": [\n        {\n            \"id\": \"3a1991b514060c2d537624eafbf985077870fc8f\",\n            \"tree_id\": \"55139603a88b7309f06211821716279f6c51bf8a\",\n            \"distinct\": true,\n            \"message\": \"Wrote migrations and repeatable data configuration for Flyway\",\n            \"timestamp\": \"2024-11-11T09:19:33\\u002B01:00\",\n            \"url\": \"https://github.com/tboulund-devops/DORAMeter/commit/3a1991b514060c2d537624eafbf985077870fc8f\",\n            \"author\": {\n                \"name\": \"tboulund\",\n                \"email\": \"tbmh@easv.dk\",\n                \"username\": \"tboulund\"\n            },\n            \"committer\": {\n                \"name\": \"tboulund\",\n                \"email\": \"tbmh@easv.dk\",\n                \"username\": \"tboulund\"\n            },\n            \"added\": [\n                \"db/R__Populate_branch_types_table.sql\",\n                \"db/V1__Create_repository_table.sql\",\n                \"db/V2__Create_branch_type_table.sql\",\n                \"db/V3__Create_branch_table.sql\"\n            ],\n            \"removed\": [],\n            \"modified\": []\n        },\n        {\n            \"id\": \"c52352841ee3680e302b3f4aa8995156a1b03be0\",\n            \"tree_id\": \"ae6efaedbcfb9b39a52da3bdb2f8c21eb1cdfe5b\",\n            \"distinct\": true,\n            \"message\": \"Removed sample\\ngit push\\n:\",\n            \"timestamp\": \"2024-11-11T09:49:29\\u002B01:00\",\n            \"url\": \"https://github.com/tboulund-devops/DORAMeter/commit/c52352841ee3680e302b3f4aa8995156a1b03be0\",\n            \"author\": {\n                \"name\": \"tboulund\",\n                \"email\": \"tbmh@easv.dk\",\n                \"username\": \"tboulund\"\n            },\n            \"committer\": {\n                \"name\": \"tboulund\",\n                \"email\": \"tbmh@easv.dk\",\n                \"username\": \"tboulund\"\n            },\n            \"added\": [],\n            \"removed\": [\n                \"docs/samples/release-ok-created.json\"\n            ],\n            \"modified\": []\n        }\n    ],\n    \"head_commit\": {\n        \"id\": \"c52352841ee3680e302b3f4aa8995156a1b03be0\",\n        \"tree_id\": \"ae6efaedbcfb9b39a52da3bdb2f8c21eb1cdfe5b\",\n        \"distinct\": true,\n        \"message\": \"Removed sample\\ngit push\\n:\",\n        \"timestamp\": \"2024-11-11T09:49:29\\u002B01:00\",\n        \"url\": \"https://github.com/tboulund-devops/DORAMeter/commit/c52352841ee3680e302b3f4aa8995156a1b03be0\",\n        \"author\": {\n            \"name\": \"tboulund\",\n            \"email\": \"tbmh@easv.dk\",\n            \"username\": \"tboulund\"\n        },\n        \"committer\": {\n            \"name\": \"tboulund\",\n            \"email\": \"tbmh@easv.dk\",\n            \"username\": \"tboulund\"\n        },\n        \"added\": [],\n        \"removed\": [\n            \"docs/samples/release-ok-created.json\"\n        ],\n        \"modified\": []\n    }\n}");
    }
}